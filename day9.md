# Day9 í•™ìŠµì •ë¦¬

# **ë°œí–‰-êµ¬ë… íŒ¨í„´(Publisher-Subscriber Pattern)**

- pub(ë°œí–‰ì) ë©”ì‹œì§€ì˜ ìˆ˜ì‹ ìê°€ ì •í•´ì ¸ ìˆì§€ ì•ŠìŒ â†’ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ëŠë‚Œ
- ë‹¨ ë¯¸ë¦¬ ì§€ì •ëœ ë²”ì£¼ì˜ sub(êµ¬ë…ì)ì—ê²Œ ë©”ì‹œì§€ê°€ ì „ë‹¬ì´ ë˜ì–´ì•¼í•¨
- pubì™€ subëŠ” ì„œë¡œì˜ ì •ë³´ë¥¼ ëª¨ë¦„

### ë°œí–‰ì

- pubì´ subì˜ ì„ ì–¸ ìœ„ì¹˜ë‚˜ ì¡´ì¬ë¥¼ ì•Œ í•„ìš”ê°€ ì—†ìŒ
- ì¤‘ê°„ ì§€ì (ë¸Œë¡œì»¤)ì— ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•˜ë©´ ë¸Œë¡œì»¤ê°€ ì•Œì•„ì„œ ì²˜ë¦¬

### êµ¬ë…ì

- sub ì—­ì‹œ pubì˜ ì„ ì–¸ ìœ„ì¹˜ë‚˜ ì¡´ì¬ë¥¼ ì•Œ í•„ìš” ì—†ìŒ
- ë¸Œë¡œì»¤ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ë©´ì„œ ì‘ì—…ì´ í• ë‹¹ë˜ë©´ ì‘ì—…ì„ ì²˜ë¦¬

### ë¸Œë¡œì»¤

- ë°œí–‰ìì™€ êµ¬ë…ì ì‚¬ì´ì— ìœ„ì¹˜
- ì£¼ë¡œ ë©”ì‹œì§€íê°€ ë¸Œë¡œì»¤ë¡œì„œì˜ ì—­í• ì„ ìˆ˜í–‰
- ë‘ ê°ì²´ ì‚¬ì´ì—ì„œ êµ¬ë…ê³¼ ë°œí–‰ ì´í›„ì˜ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬
    
    â†’ ë“¤ì–´ì˜¤ëŠ” ë©”ì‹œì§€ í•„í„°ë§ ë° êµ¬ë…ìì—ê²Œ ë°°í¬
    

### ë©”ì‹œì§€ í

í”„ë¡œì„¸ìŠ¤ë‚˜ í”„ë¡œê·¸ë¨ ì¸ìŠ¤í„´ìŠ¤ê°€ ë°ì´í„° ìƒí˜¸ êµí™˜ ì‹œ ì‚¬ìš©í•˜ëŠ” í†µì‹  ë°©ë²•

MOM(Message Oriented Middleware : ë¹„ë™ê¸° ë©”ì‹œì§€ë¥¼ ì´ìš©í•œ ë°ì´í„° ì†¡ìˆ˜ì‹ )ì˜ êµ¬í˜„ 

- ë¹„ë™ê¸°(Asynchronous) : íì— ë„£ì–´ì„œ ë‚˜ì¤‘ì— ì²˜ë¦¬ ê°€ëŠ¥
- ë¹„ë™ì¡°(Decoupling) : ì•±ê³¼ ë¶„ë¦¬ ê°€ëŠ¥
- íƒ„ë ¥ì„±(Resilience) : ì¼ë¶€ ì‹¤íŒ¨ê°€ ì „ì²´ì— ì˜í–¥x
- ê³¼ì‰(Redunadancy) : ì‹¤íŒ¨í•  ê²½ìš° ì¬ì‹¤í–‰ ê°€ëŠ¥
- ë³´ì¦(Guarantees) : ì‘ì—… ì²˜ë¦¬ í™•ì¸ ê°€ëŠ¥
- í™•ì¥ì„±(Scalable) : ë‹¤ìˆ˜ í”„ë¡œì„¸ìŠ¤ë“¤ì´ íì— ë©”ì‹œì§€ ë³´ë‚´ê¸° ê°€ëŠ¥

### ì˜µì €ë²„ íŒ¨í„´ê³¼ ë¹„êµ

ë°œí–‰-êµ¬ë… íŒ¨í„´ì€ ì˜µì €ë²„ì™€ ì˜µì €ë²„ë¸” ì‚¬ì´ì— ë¸Œë¡œì»¤(= ë©”ì‹œì§€ í, ì´ë²¤íŠ¸ ë²„ìŠ¤)ë¼ê³  ë¶ˆë¦¬ëŠ” ì¤‘ê°œìê°€ ì¡´ì¬

- ì˜µì €ë²„ íŒ¨í„´ì€ ì˜µì €ë²„ì™€ ì˜µì €ë²„ë¸”ì´ ì„œë¡œì— ëŒ€í•œ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆìŒ
- ë°œí–‰-êµ¬ë… íŒ¨í„´ì˜ ê²°í•©ë„ê°€ ë” ë‚®ìŒ
- ì˜µì €ë²„ íŒ¨í„´ì€ ë™ê¸°ì , ë°œí–‰-êµ¬ë… íŒ¨í„´ì€ ë¹„ë™ê¸°ì 
- ì˜µì €ë²„ íŒ¨í„´ì€ ë‹¨ì¼ ë„ë©”ì¸, ë°œí–‰-êµ¬ë… íŒ¨í„´ì€ í¬ë¡œìŠ¤ ë„ë©”ì¸

# **Node.js Worker threads**

## **Worker threads?**

ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¥¼ ë³‘ë ¬ì²˜ë¦¬ í•´ì£¼ëŠ” ëª¨ë“ˆ

```jsx
const { Worker } = require('worker_threads') 
```

ìœ„ì™€ ê°™ì´ importí•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥

## ìë°”ìŠ¤í¬ë¦½íŠ¸ì˜ ìŠ¤ë ˆë“œ

ìë°”ìŠ¤í¬ë¦½íŠ¸ëŠ” ì›¹ í˜ì´ì§€ì—ì„œì˜ ë™ì‹œì„± ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ êµ¬ì„±ì´ ë˜ì–´ìˆìŒ

í•˜ì§€ë§Œ `worker_threads` ëª¨ë“ˆì„ ì´ìš©í•˜ì—¬ ë©€í‹° ìŠ¤ë ˆë“œ í™˜ê²½ êµ¬ì¶• ê°€ëŠ¥

## ì‚¬ìš©ë²•

```jsx
// index.js -> ë¶€ëª¨ ìŠ¤ë ˆë“œ 
import { Worker } from 'worker_threads';

const worker = new Worker("./worker.js");
setTimeout(() => console.log("parent"));
```

```jsx
// worker.js -> ìì‹ ìŠ¤ë ˆë“œ 
console.log('child')
```

### ìƒˆë¡œìš´ ìŠ¤ë ˆë“œ(worker) ë§Œë“¤ê¸°

```jsx
const worker = new Worker(â€™./worker.jsâ€™)
```

<aside>
ğŸ’¡ new Worker(filename)Â ë˜ëŠ”Â new Worker(code, {eval: true})

</aside>

- íŒŒì¼ë¡œ ìŠ¤ë ˆë“œ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ì •í•˜ê¸°
- ì‹¤í–‰í•˜ê³ ì í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„± ë° ë„˜ê¸°ê¸°

```jsx
import { Worker, isMainThread } from 'worker_threads';
if(isMainThread){
	const worker = new Worker(__filename);
	// ë©”ì¸ ìŠ¤ë ˆë“œ ë‚´ìš©
}
else{
	//ì›Œì»¤ ìŠ¤ë ˆë“œ ë‚´ìš© 
}
```

- `isMainThread` ë¥¼ ì´ìš©í•˜ì—¬ ë‹¨ì¼ íŒŒì¼ì—ì„œ ì›Œì»¤ ì„¤ì • ê°€ëŠ¥

### ë‹¤ì¤‘ ìŠ¤ë ˆë“œ ì‚¬ìš©

```jsx
import { Worker, isMainThread } from 'worker_threads';
if (isMainThread) {
	const threads = new Set();
	threads.add(
    new Worker(__filename, {
      workerData: {start: 1},
    })
  );
  threads.add(
    new Worker(__filename, {
      workerData: {start: 2},
    })
	);
}
	
```

- Setì—ë‹¤ Worker ì €ì¥ ë° ì‚¬ìš©

### **ë©”ì„¸ì§€ ì „ì†¡**

ë¶€ëª¨ ìŠ¤ë ˆë“œ(ë©”ì¸ ìŠ¤ë ˆë“œ)ì™€ ìì‹ ìŠ¤ë ˆë“œ(worker) ê°„ì˜ í†µì‹ 

```jsx
// index.js
import { Worker } from "worker_threads";

const worker = new Worker("./worker.js");
worker.on("message", (msg) => {
  console.log(msg);
});
console.log("parent");
```

```jsx
// worker.js
import { parentPort } from "worker_threads";

parentPort.postMessage("hello parent!");
console.log("child");
```

index.jsì—ì„œ ìƒì„±í•œ workerê°€ parentì—ê²ŒÂ `â€˜hello parent!â€™`ë¼ëŠ” ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ë’¤, ê·¸ ì´ë²¤íŠ¸ë¥¼ ë°›ì€ parentê°€ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ëŠ” ì½”ë“œ

- **worker.on(ì´ë²¤íŠ¸ íƒ€ì…, ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ë‹¬ë¼ì§)**
    - ì²« ë²ˆì§¸ ì¸ìë¡œ ì´ë²¤íŠ¸ íƒ€ì… ë°›ìŒ
    - ë‹¤ìŒ ì¸ìë¥¼ í™œìš©í•˜ì—¬ ì´ë²¤íŠ¸ í•¸ë“¤ë§
    - ì´ë²¤íŠ¸ íƒ€ì…ì€ `â€˜messageâ€™`,Â `â€˜errorâ€™`,Â `â€˜exitâ€™` ê°€ ì¡´ì¬
- **postMessage(ì…ë ¥ ê°’)**
    - ì…ë ¥ ê°’ì„ ìˆ˜ì‹ ë‹¨ìœ¼ë¡œ ì „ì†¡
    - ì›ì‹œê°’, Array, Boolean, String, Set, Map ë“± ì—¬ëŸ¬ íƒ€ì…ì„ ì „ë‹¬ ê°€ëŠ¥
    - ë‹¤ë§Œ Object, ErrorëŠ” ì¡°ê±´ ì¡´ì¬
- **worker.terminate()**
    - ì›Œì»¤ ìŠ¤ë ˆë“œì˜ ëª¨ë“  ì‹¤í–‰ì„ â€˜ê°€ëŠ¥í•œ í•œâ€™ ë¹¨ë¦¬ ì •ì§€
    - Promiseë¥¼ ë°˜í™˜
    - ëŒ€ì‹  process.exit()ë„ ì‚¬ìš© ê°€ëŠ¥
- parentPort: parent threadì™€ communicationí•˜ëŠ” ë„êµ¬
    
    ```jsx
    parentPort.postMessage('pong');
    ```
    
    parent threadë¡œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ê¸°
    
    ```jsx
    parentPort.on('message',()=>{})
    ```
    
    parent threadë¡œ ë¶€í„° ë©”ì„¸ì§€ ë°›ê¸°
    

# EventEmitter

Nodejsì˜ EventLoopëŠ” ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë¹„ë™ê¸° ì´ë²¤íŠ¸ë¥¼ íŠ¹ì • ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬

ë°˜ë©´ì— EventEmitterëŠ” íŠ¹ì • ì´ë²¤íŠ¸ì— ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë¥¼ ë‹¬ì•„ì„œ, ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì´ë¥¼ ìºì¹˜í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì§„ api